---
tags:
  - CSAPP
---
一个系统中的进程是与其他进程共享 CPU 和主存资源的：
- 随着对 CPU 需求的增长，进程就会变慢；
- 但是如果太多的进程需要太多的内存，就会导致一些无法运行，并且一个进程误写了另一个进程使用的内存，就可能会导致错误；

为了更有效地管理内存并且少出错，现代系统提供了一种对主存的抽象概念，称为 **虚拟内存(VM)**：
> VM = **硬件异常** + **硬件地址翻译** + **主存** + **磁盘文件** + **内核软件** 的交互协作
> 为 **每个进程** 提供一个大的、连续的、私有的地址空间。

虚拟内存提供了三个重要的能力：
1. **把主存看作磁盘的高速缓存**
	- 主存只保存活动区域；
	- 磁盘保存完整地址空间；
	- 根据需要在磁盘和主存间传送数据（就不会内存不够了）；
2. **给每个进程提供一致的地址空间**
	- 不用关心物理内存是否碎片；
	- 简化了内存管理与程序设计；
3. **保护每个进程的地址空间不被破坏**
	- 一个进程不能访问其他的进程的内存；
	- 错误访问直接触发异常；

为什么需要理解虚拟内存：
- 虚拟内存遍及计算机系统的所有层面，在硬件异常、汇编器、链接器、加载器、共享对象、文件和进程的设计中都扮演者重要的角色，是理解系统是如何工作的重要一环；
- 虚拟内存使得应用程序可以，按需创建/销毁内存、把文件映射成内存、多进程共享内存、通过读写内存来读写文件；
- 同时，每次应用程序引用一个变量、间接引用一个指针、或者调用像 `malloc/free` 这样的动态分配程序时，就会和虚拟内存发生交互。如果使用不当，就会导致错误；

本章将从 VM 如何工作 以及 程序如何使用 VM 两个部分来讲述：

---
# 9.1 物理和虚拟寻址
计算机系统的主存是一个 **由连续的字节大小的单元** 组成的数组，每个字节都有一个唯一的 **物理地址(Physical Address，PA)**。

CPU 访问内存最自然的方式就是通过物理地址，这种方式称为 **物理寻址(physical addressing)**。

如图 9-1 所示为一个物理寻址的示例，CPU 执行一条加载指令（读取从物理地址 4 处开始的 4 字节字），执行时会生成一个有效物理地址，通过内存总线传递给主存，然后主存返回数据给 CPU（CPU 会将它存放在一个寄存器中）：
![[NoteAboutStudy/attachments/Pasted image 20260117204804.png]]

现代处理器使用的是称为 **虚拟寻址(virtual addressing)** 的寻址形式，如图 9-2 所示：
![[NoteAboutStudy/attachments/Pasted image 20260117204945.png]]