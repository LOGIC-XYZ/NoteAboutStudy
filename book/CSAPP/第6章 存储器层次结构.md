到目前为止，在对系统的研究中，都依赖于一个简单的计算机系统模型，CPU 执行指令，而存储器系统为 CPU 存放指令和数据。在简单模型中，存储器系统是一个线性的字节数组，而 CPU 能够在一个常数时间内访问每个存储器位置。虽然迄今为止这都是一个有效的模型，但是它并没有反映现代系统实际工作的方式。

实际上，**存储器系统(memory system)** 是一个具有不同容量、成本和访问时间的存储设备的层次结构。CPU 寄存器保存着最常用的数据。靠近 CPU 的小的、快速的 **高速缓存存储器(cache memory)** 作为一部分存储在相对慢速的主存储器(main memory)中数据和指令的缓冲区域。主存缓存存储在容量较大的、慢速磁盘上的数据，而这些磁盘常常又作为存储在通过网络连接的其他机器的磁盘或磁带上的数据的缓冲区域。

存储器层次结构是可行的，这是因为与下一个更低层次的存储设备相比来说，一个编写良好的程序倾向于更频繁地访问某一个层次上的存储设备。所以，下一层的存储设备可以更慢速一点，也因此可以更大，每个比特位更便宜。整体效果是一个大的存储器池，其成本与层次结构底层最便宜的存储设备相当，但是却以接近于层次结构顶部存储设备的高速率向程序提供数据。

同时，存储器的层次结构对应用程序的性能有巨大的影响，因为不同存储位置访问成本差异巨大。
为此，程序员需要理解存储器层次结构，以在编写程序时，使得它们的数据项存储在层次结构中较高的地方，以便 CPU 能更快地访问到。
而这围绕着计算机程序的一个基本属性：**局部性（locality）** -- 具有良好局部性的程序倾向于一次又一次地访问相同的数据项集合，或是倾向于访问邻近的数据项集合。具有良好局部性的程序比局部性差的程序更多地倾向于从存储器层次结构中较高层次处访问数据项，因此运行得更快。

在本章中，将会讲述基本的存储技术 - SRAM 存储器、DRAM 存储器、ROM 存储器以及旋转的和固态的硬盘 -- 并描述它们是如何被组织成层次结构的。特别地，将主要讲述高速缓存存储器，它是作为 CPU 和主存之间的缓存区域，因为它们对应用程序性能的影响最大。将展示如何分析 C 程序的局部性，并且介绍改进程序中局部性的技术。还将讲述一种描绘某台机器上存储器层次结构的性能的方法，称为 “存储器山（memorymountain）”，它展示出读访问时间是局部性的一个函数。

---
# 6.1 存储技术
计算机技术的成功很大程度上源自于存储技术的巨大进步。

---
## 6.1.1 随机访问存储器
随机访问存储器（Random-AccessMemory，RAM）分为两类：静态的和动态的。静态 RAM（SRAM）比动态 RAM（DRAM）更快，但也贵得多。SRAM 用来作为高速缓存存储器，既可以在CPU芯片上，也可以在片下。DRAM 用来作为主存以及图形系统的帧缓冲区。

### 1. 静态 RAM
SRAM 将每个位存储在一个 **双稳态的（bistable）** 存储器单元里。每个单元是用一个六晶体管电路来实现的。这个电路有这样一个属性，它可以无限期地保持在两个不同的电压配置（configuration）或状态（state）之一。其他任何状态都是不稳定的 -- 如果在不稳定状态，电路会迅速地转移到两个稳定状态中的一个。这样一个存储器单元类似于图 6-1 中画出的倒转的钟摆。
![[NoteAboutStudy/attachments/Pasted image 20251104215528.png]]

由于 SRAM 存储器单元的双稳态特性，只要有电，它就会永远地保持它的值。即使有干扰（例如电子噪音）来扰乱电压，当干扰消除时，电路就会恢复到稳定值。

### 2. 动态 RAM
DRAM 将每个位存储为对一个电容的充电。而这个电容非常小，因此 DRAM 存储器可以制造得非常密集 -- 每个单元由一个电容和一个访问晶体管组成。

但是，与 SRAM 不同，DRAM 存储器单元对干扰非常敏感。当电容的电压被扰乱之后，它就永远不会恢复了。暴露在光线下会导致电容电压改变。实际上，数码照相机和摄像机中的传感器本质上就是 DRAM 单元的阵列。

图 6-2 总结了 SRAM 和 DRAM 存储器的特性。只要有供电，SRAM 就会保持不变。与 DRAM 不同，它不需要刷新。SRAM 的存取比 DRAM 快。SRAM 对诸如光和电噪声这样的干扰不敏感。代价是 SRAM 单元比 DRAM 单元使用更多的晶体管，因而密集度低，而且更贵，功耗更大。
![[NoteAboutStudy/attachments/Pasted image 20251104220048.png]]

### 3. 传统的 DRAM
DRAM 芯片中的单元（位）被分成 $d$ 个 **超单元（supercell）**，每个超单元都由 $w$ 个 DRAM 单元组成。一个 $d×w$ 的 DRAM 总共存储了 $dw$ 位信息。超单元被组织成一个 $r$ 行 $c$ 列的长方形阵列，这里 $rc=d$。每个超单元有形如 $(i,j)$ 的地址，这里 $i$ 表示行，而 $j$ 表示列。如图 6-3 为例子。

![[NoteAboutStudy/attachments/Pasted image 20251104221149.png]]

> [!tip]- 关于 超单元 的注释
> 存储领域从来没有为 DRAM 的阵列元素确定一个标准的名字。计算机构架师倾向于称之为“单元”，使这个术语具有 DRAM 存储单元之意。电路设计者倾向于称之为“字”，使之具有主存一个字之意。为了避免混淆，本书采用了无歧义的术语“超单元”。

每个 DRAM 芯片被连接到某个称为 **内存控制器（memory controller）** 的电路，这个电路可以一次传送 $w$ 位到每个 DRAM 芯片或一次从每个 DRAM 芯片传出 $w$ 位。为了读出超单元 $(i,j)$ 的内容，内存控制器将行地址 $i$ 发送到 DRAM，然后是列地址 $j$。DRAM 把超单元 $(i,j)$ 的内容发回给控制器作为响应。行地址 $i$ 称为 RAS（Row Access Strobe，行访问选通脉冲）请求。列地址 $j$ 称为CAS（Column Access Strobe，列访问选通脉冲）请求。注意，RAS 和 CAS 请求共享相同的 DRAM 地址引I脚。

![[NoteAboutStudy/attachments/Pasted image 20251104221216.png]]

电路设计者将 DRAM 组织成二维阵列而不是线性数组的一个原因是降低芯片上地址引脚的数量。

### 4. 内存模块
