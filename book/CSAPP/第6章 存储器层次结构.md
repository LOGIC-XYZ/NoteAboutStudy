到目前为止，在对系统的研究中，都依赖于一个简单的计算机系统模型，CPU 执行指令，而存储器系统为 CPU 存放指令和数据。在简单模型中，存储器系统是一个线性的字节数组，而 CPU 能够在一个常数时间内访问每个存储器位置。虽然迄今为止这都是一个有效的模型，但是它并没有反映现代系统实际工作的方式。

实际上，**存储器系统(memory system)** 是一个具有不同容量、成本和访问时间的存储设备的层次结构。CPU 寄存器保存着最常用的数据。靠近 CPU 的小的、快速的 **高速缓存存储器(cache memory)** 作为一部分存储在相对慢速的主存储器(main memory)中数据和指令的缓冲区域。主存缓存存储在容量较大的、慢速磁盘上的数据，而这些磁盘常常又作为存储在通过网络连接的其他机器的磁盘或磁带上的数据的缓冲区域。

存储器层次结构是可行的，这是因为与下一个更低层次的存储设备相比来说，一个编写良好的程序倾向于更频繁地访问某一个层次上的存储设备。所以，下一层的存储设备可以更慢速一点，也因此可以更大，每个比特位更便宜。整体效果是一个大的存储器池，其成本与层次结构底层最便宜的存储设备相当，但是却以接近于层次结构顶部存储设备的高速率向程序提供数据。

同时，存储器的层次结构对应用程序的性能有巨大的影响，因为不同存储位置访问成本差异巨大。
为此，程序员需要理解存储器层次结构，以在编写程序时，使得它们的数据项存储在层次结构中较高的地方，以便 CPU 能更快地访问到。
而这围绕着计算机程序的一个基本属性：**局部性（locality）** -- 具有良好局部性的程序倾向于一次又一次地访问相同的数据项集合，或是倾向于访问邻近的数据项集合。具有良好局部性的程序比局部性差的程序更多地倾向于从存储器层次结构中较高层次处访问数据项，因此运行得更快。

在本章中，将会讲述基本的存储技术 - SRAM 存储器、DRAM 存储器、ROM 存储器以及旋转的和固态的硬盘 -- 并描述它们是如何被组织成层次结构的。特别地，将主要讲述高速缓存存储器，它是作为 CPU 和主存之间的缓存区域，因为它们对应用程序性能的影响最大。将展示如何分析 C 程序的局部性，并且介绍改进程序中局部性的技术。还将讲述一种描绘某台机器上存储器层次结构的性能的方法，称为 “存储器山（memorymountain）”，它展示出读访问时间是局部性的一个函数。

---
# 6.1 存储技术
计算机技术的成功很大程度上源自于存储技术的巨大进步。

---
## 6.1.1 随机访问存储器
随机访问存储器（Random-AccessMemory，RAM）分为两类：静态的和动态的。静态 RAM（SRAM）比动态 RAM（DRAM）更快，但也贵得多。SRAM 用来作为高速缓存存储器，既可以在CPU芯片上，也可以在片下。DRAM 用来作为主存以及图形系统的帧缓冲区。

### 1. 静态 RAM
SRAM 将每个位存储在一个 **双稳态的（bistable）** 存储器单元里。每个单元是用一个六晶体管电路来实现的。这个电路有这样一个属性，它可以无限期地保持在两个不同的电压配置（configuration）或状态（state）之一。其他任何状态都是不稳定的 -- 如果在不稳定状态，电路会迅速地转移到两个稳定状态中的一个。这样一个存储器单元类似于图 6-1 中画出的倒转的钟摆。
![[NoteAboutStudy/attachments/Pasted image 20251104215528.png]]

由于 SRAM 存储器单元的双稳态特性，只要有电，它就会永远地保持它的值。即使有干扰（例如电子噪音）来扰乱电压，当干扰消除时，电路就会恢复到稳定值。

### 2. 动态 RAM
DRAM 将每个位存储为对一个电容的充电。而这个电容非常小，因此 DRAM 存储器可以制造得非常密集 -- 每个单元由一个电容和一个访问晶体管组成。

但是，与 SRAM 不同，DRAM 存储器单元对干扰非常敏感。当电容的电压被扰乱之后，它就永远不会恢复了。暴露在光线下会导致电容电压改变。实际上，数码照相机和摄像机中的传感器本质上就是 DRAM 单元的阵列。

图 6-2 总结了 SRAM 和 DRAM 存储器的特性。只要有供电，SRAM 就会保持不变。与 DRAM 不同，它不需要刷新。SRAM 的存取比 DRAM 快。SRAM 对诸如光和电噪声这样的干扰不敏感。代价是 SRAM 单元比 DRAM 单元使用更多的晶体管，因而密集度低，而且更贵，功耗更大。
![[NoteAboutStudy/attachments/Pasted image 20251104220048.png]]

### 3. 传统的 DRAM
DRAM 芯片中的单元（位）被分成 $d$ 个 **超单元（supercell）**，每个超单元都由 $w$ 个 DRAM 单元组成。一个 $d×w$ 的 DRAM 总共存储了 $dw$ 位信息。超单元被组织成一个 $r$ 行 $c$ 列的长方形阵列，这里 $rc=d$。每个超单元有形如 $(i,j)$ 的地址，这里 $i$ 表示行，而 $j$ 表示列。如图 6-3 为例子。

![[NoteAboutStudy/attachments/Pasted image 20251104221149.png]]

> [!tip]- 关于 超单元 的注释
> 存储领域从来没有为 DRAM 的阵列元素确定一个标准的名字。计算机构架师倾向于称之为“单元”，使这个术语具有 DRAM 存储单元之意。电路设计者倾向于称之为“字”，使之具有主存一个字之意。为了避免混淆，本书采用了无歧义的术语“超单元”。

每个 DRAM 芯片被连接到某个称为 **内存控制器（memory controller）** 的电路，这个电路可以一次传送 $w$ 位到每个 DRAM 芯片或一次从每个 DRAM 芯片传出 $w$ 位。为了读出超单元 $(i,j)$ 的内容，内存控制器将行地址 $i$ 发送到 DRAM，然后是列地址 $j$。DRAM 把超单元 $(i,j)$ 的内容发回给控制器作为响应。行地址 $i$ 称为 RAS（Row Access Strobe，行访问选通脉冲）请求。列地址 $j$ 称为CAS（Column Access Strobe，列访问选通脉冲）请求。注意，RAS 和 CAS 请求共享相同的 DRAM 地址引I脚。

![[NoteAboutStudy/attachments/Pasted image 20251104221216.png]]

电路设计者将 DRAM 组织成二维阵列而不是线性数组的一个原因是降低芯片上地址引脚的数量。

### 4. 内存模块
DRAM 芯片封装在 **内存模块（memorymodule）** 中，它插到主板的扩展槽上。图 6-5 展示了一个内存模块的基本思想。

![[NoteAboutStudy/attachments/Pasted image 20251104221723.png]]
示例模块用 8 个 64Mbit 的 8M×8 的 DRAM 芯片，总共存储 64MB（兆字节），这 8 个芯片编号为 0~7。每个超单元存储主存的一个字节，而用相应超单元地址为（i，j）的 8 个超单元来表示主存中字节地址 A 处的 64 位字。在图 6-5 的示例中，DRAM 0 存储第一个（低位）字节，DRAM 1 存储下一个字节，依此类推。
要取出内存地址 A 处的一个字，内存控制器将 A 转换成一个超单元地址（i，j），并将它发送到内存模块，然后内存模块再将 i 和 j 广播到每个 DRAM。作为响应，每个 DRAM 输出它的（i，j）超单元的 8 位内容。模块中的电路收集这些输出，并把它们合并成一个 64 位字，再返回给内存控制器。通过将多个内存模块连接到内存控制器，能够聚合成主存。在这种情况中，当控制器收到一个地址 A 时，控制器选择包含 A 的模块 k，将 A 转换成它的（i，j）的形式，并将（i，j）发送到模块 k。

### 5. 增强的 DRAM
有许多种 DRAM 存储器，而生产厂商试图跟上迅速增长的处理器速度，市场上就会定期推出新的种类。每种都是基于传统的 DRAM 单元，并进行一些优化，提高访问基本 DRAM 单元的速度。

|类型|优化机制|说明|
|---|---|---|
|**FPM DRAM**（Fast Page Mode）|行缓冲区连续访问|读同一行多个单元，只需一次 RAS + 多次 CAS，比传统 DRAM 快。|
|**EDO DRAM**（Extended Data Out）|CAS 信号间隔缩短|对 FPM DRAM 的增强，连续访问速度更快。|
|**SDRAM**（Synchronous DRAM）|与控制器同步时钟|使用外部时钟同步读写操作，比异步 DRAM 输出更快。|
|**DDR SDRAM**（Double Data Rate）|双倍数据速率|利用时钟上升沿和下降沿，速度翻倍；进一步有 DDR2、DDR3、DDR4，通过增加预取缓冲提升带宽。|
|**VRAM**（Video RAM）|并行读写|用于图形缓冲区，可同时读（显示屏幕）和写（更新帧缓冲），输出通过移位整个缓冲区。|

### 6. 非易失性存储器
如果断电，DRAM 和 SRAM 会丢失它们的信息，从这个意义上说，它们是 **易失的（volatile**）。另一方面，**非易失性存储器（nonvolatile memory）** 即使是在关电后，仍然保存着它们的信息。现在有很多种非易失性存储器。由于历史原因，虽然 ROM 中有的类型既可以读也可以写，但是它们整体上都被称为 **只读存储器（Read-OnlyMemory，ROM）**。 ROM 是以它们能够被重编程（写）的次数和对它们进行重编程所用的机制来区分的。
- **PROM（Programmable ROM，可编程ROM）** 只能被编程一次。PROM 的每个存储器单元有一种熔丝（fuse），只能用高电流熔断一次。
- **可擦写可编程 ROM（Erasable Programmable ROM，EPROM）** 有一个透明的石英窗口，允许光到达存储单元。紫外线光照射过窗口，EPROM 单元就被清除为 0。对 EPROM 编程是通过使用一种把 1 写入 EPROM 的特殊设备来完成的。EPROM 能够被擦除和重编程的次数的数量级可以达到 1000 次。
- **电子可擦除 PROM（Electrically Erasable PROM，EEPROM）** 类似于 EPROM，但是它不需要一个物理上独立的编程设备，因此可以直接在印制电路卡上编程。EEPROM 能够被编程的次数的数量级可以达到 $10^5$ 次。
- **闪存（flash memory）** 是一类非易失性存储器，基于 EEPROM，它已经成为了一种重要的存储技术。闪存无处不在，为大量的电子设备提供快速而持久的非易失性存储，包括数码相机、手机、音乐播放器、PDA 和笔记本、台式机和服务器计算机系统。在 6.1.3 节中，将会仔细研究一种新型的基于闪存的磁盘驱动器，称为 **固态硬盘（Solid State Disk，SSD）**，它能提供相对于传统旋转磁盘的一种更快速、更强健和更低能耗的选择。

存储在 ROM 设备中的程序通常被称为 **固件（firmware）**。当一个计算机系统通电以后，它会运行存储在 ROM 中的固件。一些系统会在固件中提供了少量基本的输入输出函数。

### 7. 访问主存
数据流通过称为 **总线（bus）** 的共享电子电路在处理器和 DRAM 主存之间来来回回。每次 CPU 和主存之间的数据传送都是通过一系列步骤来完成的，这些步骤称为 **总线事务（bus transaction）**。**读事务（read transaction）** 从主存传送数据到 CPU。**写事务（write trans action）** 从 CPU 传送数据到主存。

总线是一组并行的导线，能携带地址、数据和控制信号。取决于总线的设计，数据和地址信号可以共享同一组导线，也可以使用不同的。同时，两个以上的设备也能共享同一总线。控制线携带的信号会同步事务，并标识出当前正在被执行的事务的类型。

![[NoteAboutStudy/attachments/Pasted image 20251104223407.png]]

